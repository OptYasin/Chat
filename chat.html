<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            background: #1e1e2e;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
            height: 90vh;
            background: #2b2d42;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #1e1e2e;
        }
        .message {
            max-width: 70%;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 15px;
            word-wrap: break-word;
            display: inline-block;
            clear: both;
        }
        .message.user {
            background: #007bff;
            color: white;
            float: right;
            border-bottom-right-radius: 0;
        }
        .message.other {
            background: #3a3d5c;
            color: white;
            float: left;
            border-bottom-left-radius: 0;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #444;
            background: #2b2d42;
            border-radius: 0 0 15px 15px;
        }
        .chat-input input[type="text"] {
            flex: 1;
            border: none;
            padding: 10px;
            border-radius: 25px;
            outline: none;
            background: #3a3d5c;
            color: white;
            margin-right: 10px;
        }
        .chat-input input::placeholder {
            color: #bbb;
        }
        .chat-input button {
            border: none;
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background: #0056b3;
        }
        .thumbnail {
            max-width: 200px;
            max-height: 150px;
            border-radius: 10px;
            cursor: pointer;
        }
        video.thumbnail {
            background: black;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content img, .modal-content video {
            max-width: 90%;
            max-height: 80%;
            border-radius: 10px;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <span>ðŸ’¬ Chat - {{ username }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-sm btn-light">Ã‡Ä±kÄ±ÅŸ</a>
        </div>

        <div class="chat-messages" id="messages">
            {% for msg in messages %}
                {% if msg[2] == "file" %}
                    <div class="message {% if msg[0] == username %}user{% else %}other{% endif %}">
                        <strong>{{ msg[0] }}</strong>: 
                        {% if msg[1].endswith(".jpg") or msg[1].endswith(".png") or msg[1].endswith(".jpeg") %}
                            <img src="{{ msg[1] }}" class="thumbnail" onclick="openModal(this)">
                        {% elif msg[1].endswith(".mp4") or msg[1].endswith(".webm") %}
                            <video class="thumbnail" controls onclick="openModal(this)">
                                <source src="{{ msg[1] }}">
                            </video>
                        {% else %}
                            <a href="{{ msg[1] }}" target="_blank" class="btn btn-sm btn-light">ðŸ“Ž DosyayÄ± indir</a>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="message {% if msg[0] == username %}user{% else %}other{% endif %}">
                        <strong>{{ msg[0] }}</strong>: {{ msg[1] }}
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <form id="chatForm" class="chat-input" enctype="multipart/form-data">
            <input id="messageInput" type="text" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." autocomplete="off">
            <input id="fileInput" type="file" style="display:none">
            <button type="button" onclick="document.getElementById('fileInput').click()">ðŸ“Ž</button>
            <button type="submit">GÃ¶nder</button>
        </form>
    </div>

    <div id="modal" class="modal-overlay" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <div class="modal-content"></div>
    </div>

    <script>
        var socket = io();
        var username = "{{ username }}";

        socket.on("message", function(msg) {
            var messages = document.getElementById("messages");
            var div = document.createElement("div");

            if (msg.startsWith(username + ":")) {
                div.className = "message user";
            } else {
                div.className = "message other";
            }

            if (msg.includes("/uploads/")) {
                if (msg.match(/\.(jpg|jpeg|png)$/)) {
                    div.innerHTML = msg.replace(/(\/uploads\/\S+)/, '<img src="$1" class="thumbnail" onclick="openModal(this)">');
                } else if (msg.match(/\.(mp4|webm)$/)) {
                    div.innerHTML = msg.replace(/(\/uploads\/\S+)/, '<video class="thumbnail" controls onclick="openModal(this)"><source src="$1"></video>');
                } else {
                    div.innerHTML = msg.replace(/(\/uploads\/\S+)/, '<a href="$1" target="_blank" class="btn btn-sm btn-light">ðŸ“Ž DosyayÄ± indir</a>');
                }
            } else {
                div.innerHTML = msg;
            }

            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        });

        document.getElementById("chatForm").onsubmit = async function(e) {
            e.preventDefault();
            var input = document.getElementById("messageInput");
            var fileInput = document.getElementById("fileInput");

            if (fileInput.files.length > 0) {
                var formData = new FormData();
                formData.append("file", fileInput.files[0]);

                let response = await fetch("/upload", { method: "POST", body: formData });
                let fileUrl = await response.text();

                socket.send(fileUrl);
                fileInput.value = "";
            } else if (input.value.trim() !== "") {
                socket.send(input.value);
                input.value = "";
            }
        };

        function openModal(el) {
            var modal = document.getElementById("modal");
            var content = modal.querySelector(".modal-content");
            content.innerHTML = "";
            if (el.tagName === "IMG") {
                var img = document.createElement("img");
                img.src = el.src;
                content.appendChild(img);
            } else if (el.tagName === "VIDEO") {
                var video = document.createElement("video");
                video.src = el.querySelector("source").src;
                video.controls = true;
                video.autoplay = true;
                content.appendChild(video);
            }
            modal.classList.add("active");
        }
        function closeModal() {
            var modal = document.getElementById("modal");
            modal.classList.remove("active");
        }
    </script>
</body>
</html>
